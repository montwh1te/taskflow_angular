<div class="page-container">
  <div *ngIf="!(project$ | async)" class="state-container">
    <mat-spinner></mat-spinner>
    <p>Carregando detalhes do projeto...</p>
  </div>

  <div *ngIf="project$ | async as project">
    
    <mat-card class="detail-card project-info-card">
      <button mat-stroked-button color="primary" class="back-button" routerLink="/projects">
		<mat-icon>arrow_back</mat-icon>
		Voltar para Projetos
	  </button>

      <div class="project-header">
        <h2 class="project-title">{{ project.title }}</h2>
        <p class="project-description">{{ project.description }}</p>
      </div>

      <div class="project-actions">
        <button mat-flat-button color="primary" (click)="openProjectDialog(project)">
          <mat-icon>edit</mat-icon>
          Editar Projeto
        </button>
        <button mat-stroked-button color="warn" (click)="deleteProject(project.id)" *ngIf="project.id">
          <mat-icon>delete_outline</mat-icon>
          Excluir Projeto
        </button>
      </div>
    </mat-card>

    <mat-card class="detail-card tasks-card">
      <div class="tasks-header">
        <h3>Tarefas</h3>
        <button mat-flat-button color="accent" (click)="openTaskDialog(undefined, project.id)" *ngIf="project.id">
          <mat-icon>add</mat-icon>
          Nova Tarefa
        </button>
      </div>

      <div class="filters-container">
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Filtrar por Status</mat-label>
          <mat-select [(ngModel)]="selectedStatus">
            <mat-option value="Todos">Todos</mat-option>
            <mat-option value="A Fazer">A Fazer</mat-option>
            <mat-option value="Em Andamento">Em Andamento</mat-option>
            <mat-option value="Concluído">Concluído</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Buscar tarefa</mat-label>
          <input matInput [(ngModel)]="searchText" placeholder="Digite para buscar...">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
      </div>

      <div *ngIf="(tasks$ | async) as tasks; else loadingTasks">
        <ul *ngIf="tasks.length > 0; else noTasks" class="task-list">
          <li *ngFor="let task of tasks | taskFilter:selectedStatus | taskSearch:searchText" class="task-item">
            <div class="task-main-info">
              <span class="task-title">{{ task.title }}</span>
              <span class="status-chip" [ngClass]="{
                'a-fazer': task.status === 'A Fazer',
                'em-andamento': task.status === 'Em Andamento',
                'concluido': task.status === 'Concluído'
              }">{{ task.status }}</span>
            </div>
            <p class="task-description">{{ task.description }}</p>
            <div class="task-meta">
              <span class="due-date">
                <mat-icon>event</mat-icon>
                Vencimento: {{ task.dueDate | timestampToDate | date:'dd/MM/yyyy' }}
              </span>
              <div class="task-actions">
                <button mat-icon-button color="primary" matTooltip="Editar tarefa" (click)="openTaskDialog(task, project.id)" *ngIf="project.id">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" matTooltip="Excluir tarefa" (click)="deleteTask(task.id, project.id)" *ngIf="project.id && task.id">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </li>
        </ul>
      </div>

      <ng-template #loadingTasks>
        <div class="state-container"><mat-spinner></mat-spinner></div>
      </ng-template>

      <ng-template #noTasks>
        <div class="state-container">
          <mat-icon>assignment_late</mat-icon>
          <p>Nenhuma tarefa encontrada para este projeto.</p>
        </div>
      </ng-template>

    </mat-card>
  </div>
</div>